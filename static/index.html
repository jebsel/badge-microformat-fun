<!DOCTYPE html>
<meta charset="utf-8">
<link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
<link rel="stylesheet" href="google-code-prettify/prettify.css">
<style>
body:not(.valid-form) .valid-form-only {
  display: none;
}

body.valid-form .invalid-form-only {
  display: none;
}
</style>
<title>Badge Microformat Fun</title>
<div class="container">
<h1>Badge Microformat Fun</h1>

<form id="build">
  <fieldset>
    <legend>Build a Badge</legend>

    <div class="row">
      <div class="span4">
        <label>Badge Name</label>
        <input class="input-xlarge" type="text" name="name" required>

        <label>Badge Image URL</label>
        <input class="input-xlarge" type="url" name="image" placeholder="http://" required>

        <label>Short Badge Description</label>
        <input class="input-xlarge" type="text" name="description" required>
      </div>
      <div class="span4">
        <label>Recipient Name</label>
        <input class="input-xlarge" type="text" name="recipient-name" required>

        <label>Recipient Email</label>
        <input class="input-xlarge" type="email" name="recipient" required>

        <label class="checkbox">
          <input type="checkbox" name="hash"> Hash Recipient Email
        </label>
        <span class="help-block">Hashing the recipient's email address prevents it from being publicly known, while still allowing the badge's issuance to be verified.</span>
      </div>
      <div class="span4">
        <label>Issuance Date</label>
        <input class="input-small" type="text" name="issuance" pattern="\d\d\d\d-\d\d-\d\d">

        <label>Issuer Name</label>
        <input class="input-xlarge" type="text" name="issuer-name" required>

        <label>Issuer URL</label>
        <input class="input-xlarge" type="url" name="issuer" placeholder="http://" required>
        <span class="help-block">Note that the badge HTML <em>must</em> be hosted at the issuer's domain, or it will be invalid.</span>
      </div>
  </fieldset>
</form>

<div class="valid-form-only">
  <p>Below is your badge's HTML. Copy and paste it into a blog or other web
    page hosted at <a id="issuer-domain"></a>.
  </p>
</div>

<div class="invalid-form-only alert alert-error">
  You haven't filled out the above form properly yet, so the following HTML is invalid.
</div>

<pre id="badge-html"></pre>

<div class="valid-form-only">
  <p>Note that in order for the <strong>Push to Backpack</strong> button in
    the above snippet to work, you need to add the following script tags to
    your webpage:</p>
  <pre id="script-html"></pre>
</div>

<form action="/assertion">
  <fieldset>
    <legend>Validate a Badge</legend>

    <label>URL</label>
    <input class="input-xlarge" type="url" name="url" placeholder="http://">

    <label>Test HTML (optional)</label>
    <textarea class="input-block-level" rows="20" name="testHtml"></textarea>

    <div class="form-actions">
      <input class="btn btn-primary" type="submit" value="Validate">
    </div>
  </fieldset>
</form>

<div id="badge-template" style="display: none"><div class="h-badge">
  <h3 class="p-name"></h3>
  <img class="u-image">
  <p class="p-description"></p>
  <p>
    This badge is awarded to
    <a class="p-recipient h-card"></a>
    on
    <time class="dt-issuance"></time>
    by
    <a class="u-issuer p-issuer-name"></a>,
    in recognition of their awesomeness.
  </p>
  <input type="button" data-issue-html-badge value="Push to Backpack"/>
</div></div>
</div>

<script src="sha256.js"></script>
<script src="moment.min.js"></script>
<script src="google-code-prettify/prettify.js"></script>
<script>
var SALT = "deadsea";
var ISSUER_JS_API_URL = "http://backpack.openbadges.org/issuer.js";

var today = moment().format("YYYY-MM-DD");
var buildForm = $("#build");
var badge = $("#badge-template .h-badge");

function $(selector, element) {
  return (element || document).querySelector(selector);
}

function generateBadge() {
  var recipientUrl;
  var issueDate = moment($("[name=issuance]").value.trim() || today,
                         "YYYY-MM-DD");

  $(".p-name", badge).textContent = $("[name=name]").value;
  $(".u-image", badge).setAttribute("src", $("[name=image]").value);
  $(".p-description", badge).textContent = $("[name=description]").value;
  $(".p-recipient", badge).textContent = $("[name=recipient-name]").value;

  if ($("[name=hash]").checked)
    recipientUrl = "hmailto:" +
                   Sha256.hash($("[name=recipient]").value + SALT) +
                   "?hashfunc=sha256&salt=" +
                   encodeURIComponent(SALT);
  else
    recipientUrl = "mailto:" + $("[name=recipient]").value;

  $(".p-recipient", badge).setAttribute("href", recipientUrl);

  $(".dt-issuance", badge).textContent = issueDate
                                         ? issueDate.format("MMMM Do YYYY")
                                         : "";
  $(".dt-issuance", badge).setAttribute("datetime",
                                        issueDate
                                        ? issueDate.format("YYYY-MM-DD")
                                        : "");

  $(".u-issuer", badge).setAttribute("href", $("[name=issuer]").value);
  $(".p-issuer-name", badge).textContent = $("[name=issuer-name]").value;

  $("#badge-html").textContent = $("#badge-template").innerHTML;
  $("#badge-html").innerHTML = prettyPrintOne($("#badge-html").innerHTML,
                                                'html');

  $("#issuer-domain").setAttribute("href", $("[name=issuer]").value);
  $("#issuer-domain").textContent = $("#issuer-domain").host;

  document.body.classList.toggle("valid-form", buildForm.checkValidity());
}

function populateScriptHtml() {
  var ourJsApiUrl = location.protocol + '//' + location.host +
                    '/html-issuer.js';
  var html = '<script src="' + ISSUER_JS_API_URL + '"></' + 'script>\n' +
             '<script src="' + ourJsApiUrl + '"></' + 'script>';
  $("#script-html").textContent = html;
  $("#script-html").innerHTML = prettyPrintOne($("#script-html").innerHTML,
                                               'html');
}

$("[name=issuance]").setAttribute("placeholder", today);

buildForm.addEventListener("keyup", generateBadge, false);
buildForm.addEventListener("change", generateBadge, false);
populateScriptHtml();

onload = generateBadge;
</script>
